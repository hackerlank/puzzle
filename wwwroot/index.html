<!DOCTYPE html>   
<html>
<head>   
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>puzzle</title>  
</head>  
<body>  
<h1>puzzle</h1>  
<canvas id="c1" width="250" height="250">浏览器不支持html5！！！！</canvas> 
<canvas id="c2" width="250" height="250">浏览器不支持html5！！！！</canvas> 
<br/>
<button onclick="capture()">capture</button>
<button onclick="findpic()">findpic</button>
<br/>
<canvas id="c3" width="1200" height="750"></canvas> 
<script>
    var c1 =document.getElementById('c1').getContext('2d');
    var c2 =document.getElementById('c2').getContext('2d');
    var c3 =document.getElementById('c3').getContext('2d');

    var pic = new Image();
    pic.src="res/2.png";
    pic.onload=function(){
	  c1.drawImage(pic, 0, 0, 250, 250);
	  c2.drawImage(pic, 0, 0, 250, 250);
	}

    var all = new Image();
    all.src="res/all.png";
    all.onload=function(){
	   c3.drawImage(all,0,0);//绘制原始图像，（0,0）表示图像的左上角位与canvas画布的位置
    }

  
    var dir = [[0,1,1,1],[1,1,0,-1],[0,-1,1,-1],[1,-1,0,1]];
    //var pos = new Array();
	var pos[13][2] = [
	    [16, 12],
	    [29, 12],
	    [37, 12],
	    [36, 18],
	    [28, 18],
	    [20, 19],
	    [ 8, 25],
	    [16, 25],
	    [23, 25],
	    [16, 35],
	    [22, 34],
	    [34, 35],
	    [27, 42]];


    function capture(){
        var src = c1.getImageData(0,0,250,250);
        var dst = c2.createImageData(250,250);

        for(var j=0;j<250;j+=1)
		{
		    for(var i=0;i<250;i+=1){
                k=4*(250*j+i);
                dst.data[k+0]=255-src.data[k+0];
                dst.data[k+1]=255-src.data[k+1];
                dst.data[k+2]=255-src.data[k+2];
                dst.data[k+3]=255;
		    }
        }
        c2.putImageData(dst,0,0);
    }

    function findpic(){
		var src = c2.getImageData(0,0,250,250);
		var dst = c3.getImageData(0,0,1200,750);

		var kk = new Array();
		var tt = new Array();

        for(var i = 0; i < pos.length; i++)
		{
		    kk[i] = getPixel(src, pos[i][0]*10, pos[i][1]*10);
			pos[i][0] -= 25;
			pos[i][1] -= 25;
		}

		var ret = new Array(50);
        for(var i = 0; i < 50; i++)
		{
		    ret[i] = {p = 9999999, x = 0, y = 0, d = 0};
		}

		for(var s = 0.9; s < 1.1; s+=0.05)
		{
		    for(var y = 25; y < dst.width - 25; y+=3)
		    {
		        for(var x = 25; x < dst.height - 25; x+=3)
				{
				    for(var d = 0; d < 4; d++)
					{
					    for(var i = 0; i < pos.length; i++)
						{
						    tt[i] = getPixel(dst, 
								x + pos[i][dir[d][0]]*dir[d][1]*s, 
								y + pos[i][dir[d][2]]*dir[d][3]*s);

							var score = calc(tt, kk, pos.length);
							for(var m = 0; m < 50; m++)
							{
							    if(score < ret[m].p)
								{
								    for(var n = 50-1; n > m; n--)
									    ret[n] = ret[n-1];

									ret[m] = {p = score, x = x, y = y, d = d};
									break;
								}
							}
						}
					}
				}
		    }
		}

	    c3.drawImage(all,0,0);
	    c3.strokeStyle="#0000ff";
		for(int i = 0; i < 50; i++)
		{
	        c3.strokeRect(ret[m].x - 25,ret[m].y - 25,50,50);
		}
	}

    function getPixel(p, x, y){
	    var idx = (y * p.width + x) * 4;
		return [p.data[k], p.data[k+1], p.data[k+2]];
	}

    function calc(tt, kk, n){
	    var score = 0;
		for(var c = 0; c < 3; c++)
		{
		    for(var i = 0; i < n; i++)
			{
			    var d = (tt[i][c] - kk[i][c])/100.0;
				if(d > 0)
				  score += d;
				else
				  score -= d;

		        for(var j = i+1; j < n; j++)
				{
				    var k = (tt[i][c]/tt[j][c])/(kk[i][c]/kk[j][c]) - 1;
					if(k > 0)
					    score += k;
					else
					    score -= k;
				}
			}
		}

    
		return score;
    }


</script> 
</body>  
</html>
